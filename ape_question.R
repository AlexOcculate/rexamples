library(ape)
library(nlme)

dat <- structure(list(animal = structure(c(42L, 46L, 45L, 31L, 49L, 
30L, 29L, 11L, 13L, 27L, 8L, 44L, 47L, 25L, 9L, 4L, 37L, 38L, 
36L, 41L, 12L, 15L, 20L, 19L, 18L, 26L, 10L, 21L, 40L, 7L, 43L, 
22L, 23L, 3L, 28L, 32L, 33L, 24L, 6L, 14L, 17L, 2L, 1L, 48L, 
16L, 5L, 39L, 35L, 34L), .Label = c("Aa", "Ab", "Ac", "Aj", "Al", 
"Am", "Bb", "Ca", "Cc", "Cd", "Cp", "Cs", "Ct", "Cu", "Db", "Dd", 
"Dl", "Eb", "Ec", "Eh", "Gc", "Gg", "Gt", "He", "Hh", "Lg", "Lp", 
"Mk", "Ml", "Mp", "Nn", "Oa", "Oc", "Oh", "Ov", "Pl", "Pp", "Pt", 
"Rt", "Sc", "Tb", "Tm", "To", "Uc", "Um", "Ur", "Vf", "cc", "pl"
), class = "factor"), x = c(2.423245874, 2.400192489, 1.970346876, 
0.6434526765, 0.84509804, 0.3979400087, 1.064457989, 1.547774705, 
1.123851641, 1.301029996, 0.9444826722, 0.5682017241, 0.6812412374, 
1.428134794, 1.716003344, 1.769377326, 1.719331287, 2.206825876, 
2.192567453, 2.397940009, 3.301029996, 3.079181246, 2.301029996, 
2.544068044, 2.371067862, 1.977723605, 2.740362689, 3.031408464, 
2.792391689, 2.937016107, 2.7084209, 1.795880017, 1.311753861, 
1.574031268, 0.6989700043, 2.054995862, 1.929418926, 2.355068206, 
1.726319612, 2.334453751, 2.113943352, 2.133538908, 1.698970004, 
2.477121255, 1.740362689, 2.584331224, 2, 1.755874856, 1.86923172
), y = c(2.062957834, 1.918030337, 1.754348336, 0.0211892991, 
0.0569048513, 0.3979400087, -0.060480747, 2.307067951, 1.653212514, 
2.204119983, 0.9590413923, 0.0413926852, 0.587710965, 2.184123354, 
1.397940009, 1.7930916, 1.365487985, 1.84260924, 2.372912003, 
0.3010299957, 0.8228216453, 1.193124598, 1.544068044, 1.352182518, 
2.217483944, -0.301029996, 2, 1.927370363, 2.139879086, 2.123851641, 
1.942008053, 1.301029996, 0.7242758696, 0.8129133566, -1.36653154, 
1.356981401, 1.15624619, 1.903089987, 0.5797835966, 1.875061263, 
0.3424226808, 0.6989700043, 1, 1.111598525, 0.1139433523, 1.206825876, 
1.477121255, 0.2922560714, 0.45484486)), .Names = c("animal", 
"x", "y"), class = "data.frame", row.names = c("Tm", "Ur", "Um", 
"Nn", "pl", "Mp", "Ml", "Cp", "Ct", "Lp", "Ca", "Uc", "Vf", "Hh", 
"Cc", "Aj", "Pp", "Pt", "Pl", "Tb", "Cs", "Db", "Eh", "Ec", "Eb", 
"Lg", "Cd", "Gc", "Sc", "Bb", "To", "Gg", "Gt", "Ac", "Mk", "Oa", 
"Oc", "He", "Am", "Cu", "Dl", "Ab", "Aa", "cc", "Dd", "Al", "Rt", 
"Ov", "Oh"))

tree <- structure(list(edge = structure(c(50L, 51L, 52L, 53L, 54L, 55L, 
55L, 54L, 53L, 56L, 57L, 57L, 56L, 58L, 58L, 52L, 59L, 60L, 61L, 
62L, 63L, 63L, 62L, 61L, 60L, 59L, 51L, 64L, 65L, 65L, 64L, 66L, 
66L, 67L, 67L, 68L, 68L, 50L, 69L, 70L, 71L, 71L, 72L, 72L, 70L, 
73L, 73L, 74L, 74L, 69L, 75L, 76L, 76L, 75L, 77L, 77L, 78L, 79L, 
80L, 81L, 81L, 80L, 79L, 82L, 83L, 84L, 85L, 85L, 84L, 83L, 82L, 
86L, 87L, 87L, 86L, 88L, 88L, 89L, 89L, 90L, 90L, 91L, 91L, 78L, 
92L, 92L, 93L, 94L, 94L, 93L, 95L, 95L, 96L, 96L, 97L, 97L, 51L, 
52L, 53L, 54L, 55L, 1L, 2L, 3L, 56L, 57L, 4L, 5L, 58L, 6L, 7L, 
59L, 60L, 61L, 62L, 63L, 8L, 9L, 10L, 11L, 12L, 13L, 64L, 65L, 
14L, 15L, 66L, 16L, 67L, 17L, 68L, 18L, 19L, 69L, 70L, 71L, 20L, 
72L, 21L, 22L, 73L, 23L, 74L, 24L, 25L, 75L, 76L, 26L, 27L, 77L, 
28L, 78L, 79L, 80L, 81L, 29L, 30L, 31L, 82L, 83L, 84L, 85L, 32L, 
33L, 34L, 35L, 86L, 87L, 36L, 37L, 88L, 38L, 89L, 39L, 90L, 40L, 
91L, 41L, 42L, 92L, 43L, 93L, 94L, 44L, 45L, 95L, 46L, 96L, 47L, 
97L, 48L, 49L), .Dim = c(96L, 2L)), edge.length = c(12, 6, 8, 
39, 3, 2, 2, 5, 13, 26, 5, 5, 11, 20, 20, 42.5, 0.5, 3, 3, 0.5, 
2.5, 2.5, 3, 6, 9, 9.5, 32, 21, 5, 5, 17, 9, 6.5, 2.5, 0.5, 2, 
2, 4, 10, 6, 50, 37, 13, 13, 49, 7, 1, 6, 6, 23, 25.5, 17.5, 
17.5, 22.5, 20.5, 0.5, 0.5, 0.5, 9, 10, 10, 19, 3.5, 5, 4, 4.5, 
2.5, 2.5, 7, 11, 0.5, 11.5, 4, 4, 6.5, 9, 2.5, 6.5, 1, 5.5, 2, 
3.5, 3.5, 0.5, 19.5, 8.5, 7, 4, 4, 5.5, 5.5, 0.5, 5, 4, 1, 1), 
    Nnode = 48L, node.label = c("01#", "03#", "05#", "06#", "31#", 
    "95#", "93#", "92#", "07#", "21#", "22#", "28#", "32#", "34#", 
    "10#", "18#", "23#", "35#", "36#", "02#", "04#", "99#", "16#", 
    "26#", "29#", "88#", "77#", "08#", "09#", "12#", "24#", "98#", 
    "13#", "19#", "90#", "27#", "14#", "97#", "91#", "20#", "30#", 
    "33#", "11#", "17#", "96#", "37#", "38#", "39#"), root.edge = 0, 
    tip.label = c("Tm", "Ur", "Um", "Nn", "pl", "Mp", "Ml", "Cp", 
    "Ct", "Lp", "Ca", "Uc", "Vf", "Hh", "Cc", "Aj", "Pp", "Pt", 
    "Pl", "Tb", "Cs", "Db", "Eh", "Ec", "Eb", "Lg", "Cd", "Gc", 
    "Sc", "Bb", "To", "Gg", "Gt", "Ac", "Mk", "Oa", "Oc", "He", 
    "Am", "Cu", "Dl", "Ab", "Aa", "cc", "Dd", "Al", "Rt", "Ov", 
    "Oh")), .Names = c("edge", "edge.length", "Nnode", "node.label", 
"root.edge", "tip.label"), class = "phylo", origin = "49LBR70.PDI.nex")

W <- diag(vcv.phylo(tree)) # Weights

## Fail
fm <- gls(y ~ x, data = dat, 
          correlation = corMartins(value = 1, tree, fixed = FALSE),
          weights = ~ W,
          method = "REML")

myou <- function(alpha, dat, tree){
  W <- diag(vcv.phylo(tree)) # Weights
  fm <- gls(y ~ x, data = dat, 
            correlation = corMartins(alpha, tree, fixed = TRUE),
            weights = ~ W,
            method = "REML")
  return(as.numeric(fm$logLik))
}

result <- optimize(f = myou, interval = c(0, 2), 
                   dat = dat, tree = tree, maximum = TRUE)

fm <- gls(y ~ x, data = dat, 
          correlation = corMartins(result$maximum, tree, fixed = true),
          weights = ~ W,
          method = "REML")
summary(fm)

## Start value near alpha
fm <- gls(y ~ x, data = dat, 
          correlation = corMartins(value = 0.1, tree, fixed = FALSE),
          weights = ~ W,
          method = "REML")
fm
